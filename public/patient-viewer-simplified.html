<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHIRHub - Visualiseur de Patient</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/sidebar-menu.css">
    <link rel="stylesheet" href="css/fhir-browser.css">
    <link rel="stylesheet" href="css/support-chatbot.css">
    <link rel="stylesheet" href="css/ai-indicator.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="js/support-chatbot.js" defer></script>
    <script src="js/ai-provider-indicator.js" defer></script>
    <script src="js/include-sidebar.js" defer></script>
    <script src="js/sidebar-menu.js" defer></script>
    <script src="js/patient-utils.js" defer></script>
    <script src="js/patient-viewer-loaders.js" defer></script>
    <script src="js/patient-viewer.js" defer></script>
    <style>
        /* Ajout de styles inline complémentaires */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        .resource-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 15px 10px;
        }
        .resource-item:hover {
            background-color: #f9f9f9;
        }
        .resource-item .resource-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .resource-name {
            font-weight: 600;
            color: #333;
        }
        .resource-details {
            color: #666;
            font-size: 0.9rem;
        }
        .group-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .group-header:hover {
            background-color: #f0f0f0;
        }
        .group-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .group-title {
            flex-grow: 1;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Menu latéral chargé dynamiquement via include-sidebar.js -->
        <div id="sidebar"></div>
        
        <div class="main-content">
            <div class="content-header">
                <h1>Visualiseur de Patient FHIR</h1>
                <p>Recherchez et visualisez les informations des patients depuis un serveur FHIR</p>
            </div>
            
            <div class="patient-search-section" style="background-color: white; border-radius: 12px; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 25px;">
                <div class="server-select-group" style="margin-bottom: 20px;">
                    <label for="serverSelect" style="display: block; margin-bottom: 10px; font-weight: 500; color: #555;">Serveur FHIR :</label>
                    <select id="serverSelect" class="server-select" style="width: 100%; padding: 15px; border-radius: 8px; border: 1px solid #ddd; appearance: none; background: white url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M6 9l6 6 6-6\"/></svg>') no-repeat right 15px center; background-size: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03);">
                        <option value="https://hapi.fhir.org/baseR4">HAPI FHIR Public Server (R4)</option>
                        <option value="http://localhost:8080/fhir">Serveur HAPI FHIR Local (R4)</option>
                    </select>
                </div>
                
                <div class="search-form" style="margin-bottom: 20px;">
                    <label for="patientSearchInput" style="display: block; margin-bottom: 10px; font-weight: 500; color: #555;">Rechercher un patient :</label>
                    <div style="position: relative;">
                        <i class="fas fa-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999;"></i>
                        <input type="text" id="patientSearchInput" placeholder="Entrez le nom de famille du patient (ex: Martin)" 
                          style="width: 100%; padding: 15px 15px 15px 45px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 2px 10px rgba(0,0,0,0.03); font-size: 1rem; transition: all 0.3s ease;">
                    </div>
                </div>
                
                <div class="search-buttons" style="display: flex; gap: 10px;">
                    <button id="searchPatientBtn" class="btn-gradient-primary" 
                           style="background: linear-gradient(135deg, #e83e28, #fd7e30); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 500; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(232, 62, 40, 0.2); transition: all 0.3s ease; cursor: pointer;">
                        <i class="fas fa-search"></i> Rechercher
                    </button>
                    <button id="clearSearchBtn" class="btn-outline-secondary"
                           style="background: transparent; color: #666; border: 1px solid #ddd; padding: 12px 20px; border-radius: 8px; font-weight: 500; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; cursor: pointer;">
                        <i class="fas fa-times"></i> Effacer
                    </button>
                </div>
                
                <div id="serverStatus" class="status-display" style="display: none;"></div>
                
                <div class="patient-select-group" style="margin-top: 20px;">
                    <label for="patientSelect" style="display: block; margin-bottom: 10px; font-weight: 500; color: #555;">Patients trouvés :</label>
                    <select id="patientSelect" class="patient-select" style="width: 100%; padding: 15px; border-radius: 8px; border: 1px solid #ddd; appearance: none; background: white url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M6 9l6 6 6-6\"/></svg>') no-repeat right 15px center; background-size: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03);">
                        <option value="">-- Sélectionnez un patient --</option>
                    </select>
                    
                    <div class="search-buttons" style="margin-top: 20px; display: flex; justify-content: flex-end;">
                        <button id="loadPatientBtn" class="btn-gradient-primary" style="background: linear-gradient(135deg, #e83e28, #fd7e30); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: 500; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(232, 62, 40, 0.2); transition: all 0.3s ease; cursor: pointer;">
                            <i class="fas fa-user"></i> Charger le patient
                        </button>
                    </div>
                </div>
            </div>
                    
            <div id="patientContainer" class="patient-data-section" style="display: none; background-color: white; border-radius: 12px; padding: 0; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 25px; overflow: hidden;">
                <div id="patientHeader" class="patient-header" style="background: linear-gradient(135deg, #e83e28, #fd7e30); border-radius: 0; padding: 30px; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="patient-info">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <div style="background: rgba(255,255,255,0.2); width: 50px; height: 50px; border-radius: 25px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-user-circle" style="font-size: 24px;"></i>
                                </div>
                                <h3 id="patientName" style="margin: 0; font-size: 1.6rem; font-weight: 600;">Nom du patient</h3>
                            </div>
                            <div id="patientDetails" style="font-size: 1rem; opacity: 0.9; margin-left: 65px;">Détails du patient</div>
                        </div>
                        <div class="patient-actions">
                            <button id="analyzeAIBtn" class="btn-gradient-primary" style="background: rgba(255,255,255,0.2); box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.3); padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500; display: flex; align-items: center; gap: 10px; transition: all 0.3s ease; cursor: pointer;">
                                <i class="fas fa-microchip"></i> Analyse IA intelligente
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="tabs-container" style="margin-top: 0; padding: 20px;">
                    <style>
                        .tabs-rows {
                            margin-bottom: 20px;
                            border-bottom: 1px solid #eee;
                        }
                        .tabs-row {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 4px;
                            margin-bottom: 4px;
                        }
                        .tab {
                            display: flex;
                            align-items: center;
                            gap: 6px;
                            padding: 8px 16px;
                            border-radius: 8px 8px 0 0;
                            background: #f5f5f5;
                            color: #555;
                            font-weight: 500;
                            cursor: pointer;
                            white-space: nowrap;
                            font-size: 0.9rem;
                        }
                        .tab.active {
                            background: linear-gradient(135deg, #e83e28, #fd7e30);
                            color: white;
                        }
                        .tab:hover:not(.active) {
                            background: #ebebeb;
                        }
                    </style>
                    
                    <div class="tabs-rows">
                        <!-- Onglets simplifiés -->
                        <div class="tabs-row">
                            <div class="tab active" data-tab="summary">
                                <i class="fas fa-clipboard-list"></i> Résumé Patient
                            </div>
                            <div class="tab" data-tab="bundle">
                                <i class="fas fa-box" style="color: #fd7e30;"></i> Bundle
                            </div>
                            <div class="tab" data-tab="json">
                                <i class="fas fa-code" style="color: #fd7e30;"></i> JSON
                            </div>
                        </div>
                    </div>
                    
                    <!-- Onglet de résumé du patient -->
                    <div class="tab-content active" id="summary" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <div id="aiAnalysis" style="margin-bottom: 20px; display: none;"></div>
                        <div id="summaryContent"></div>
                    </div>
                    
                    <!-- Onglet Bundle FHIR -->
                    <div class="tab-content" id="bundle" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: none;">
                        <div id="bundleContent">
                            <div class="bundle-info" id="bundle-info-container" style="display: none; margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px;">
                                <h3 style="margin-top: 0; margin-bottom: 15px; font-size: 1.2rem; color: #333;">Informations du Bundle</h3>
                                <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                                    <div>
                                        <span style="font-weight: 600; color: #555;">ID:</span>
                                        <span id="bundle-id">-</span>
                                    </div>
                                    <div>
                                        <span style="font-weight: 600; color: #555;">Type:</span>
                                        <span id="bundle-type">-</span>
                                    </div>
                                    <div>
                                        <span style="font-weight: 600; color: #555;">Ressources:</span>
                                        <span id="bundle-resource-count">0</span>
                                    </div>
                                    <div>
                                        <span style="font-weight: 600; color: #555;">Types:</span>
                                        <span id="bundle-resource-types">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="bundle-loading-section" class="loading-resources" style="text-align: center; padding: 30px 20px;">
                                <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #e83e28; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                <p style="margin-top: 15px; color: #666;">Chargement du bundle FHIR...</p>
                            </div>
                            
                            <div id="bundle-resources-list"></div>
                        </div>
                    </div>
                    
                    <!-- Onglet JSON pour données brutes -->
                    <div class="tab-content" id="json" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: none;">
                        <div id="jsonContent">
                            <div class="json-panel">
                                <h3 style="margin-top: 0;">Données JSON du patient</h3>
                                <div class="json-viewer">
                                    <pre id="json-content" style="background-color: #f9f9f9; padding: 15px; border-radius: 8px; overflow: auto; max-height: 600px; margin-top: 15px; white-space: pre-wrap;"></pre>
                                </div>
                            </div>
                            <div class="json-preview-section">
                                <h4 style="margin-top: 20px;">Aperçu des ressources associées</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 15px;">
                                    <div class="json-preview-card">
                                        <h5>Conditions</h5>
                                        <pre id="conditions-preview" style="background-color: #f9f9f9; padding: 10px; border-radius: 6px; overflow: auto; max-height: 200px; font-size: 0.8rem;">// Aucune condition disponible</pre>
                                    </div>
                                    <div class="json-preview-card">
                                        <h5>Observations</h5>
                                        <pre id="observations-preview" style="background-color: #f9f9f9; padding: 10px; border-radius: 6px; overflow: auto; max-height: 200px; font-size: 0.8rem;">// Aucune observation disponible</pre>
                                    </div>
                                    <div class="json-preview-card">
                                        <h5>Médicaments</h5>
                                        <pre id="medications-preview" style="background-color: #f9f9f9; padding: 10px; border-radius: 6px; overflow: auto; max-height: 200px; font-size: 0.8rem;">// Aucun médicament disponible</pre>
                                    </div>
                                    <div class="json-preview-card">
                                        <h5>Consultations</h5>
                                        <pre id="encounters-preview" style="background-color: #f9f9f9; padding: 10px; border-radius: 6px; overflow: auto; max-height: 200px; font-size: 0.8rem;">// Aucune consultation disponible</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="patientStatusContainer" class="status-container" style="display: none; padding: 15px 20px; background-color: #f0f0f0; border-top: 1px solid #ddd;">
                    <div id="patientStatus" class="status-message"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Détection du chargement complet de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Initialisation manuelle des onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Retirer la classe active de tous les onglets
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    // Cacher tous les contenus d'onglet
                    document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
                    
                    // Ajouter la classe active à l'onglet cliqué
                    this.classList.add('active');
                    
                    // Afficher le contenu correspondant
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).style.display = 'block';
                });
            });
        });
    </script>
</body>
</html>